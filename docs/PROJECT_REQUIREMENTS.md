# Project Requirements

## プロジェクトの目的

Notion データベースの変更を自動検知し、変更内容をマークダウン形式でまとめてGitHub Pull Requestとして可視化する自動化システムを構築する。

### 実現したい機能
1. Notion APIにアクセスし、対象のデータベースに変更があるかチェックする
2. 変更があれば、変更内容をマークダウン形式でまとめる
3. 作成したマークダウンを使用してGitHubにPRを作成し、レビュー可能な状態にする
4. 上記の工程を毎日同じ時刻に繰り返し行う
5. 作成したPRがマージされておらず、翌日以降のチェックでさらに変更があれば、既存のPRの内容に追記する形で変更をまとめる

## 機能要件

### 1. Notion変更検知機能
- **目的**: 対象データベースの変更を検知
- **必要な機能**:
  - Notion APIクライアントの初期化
  - データベース情報の取得
  - 前回取得時との差分検出
  - 変更状態の永続化（ファイルまたはDB）

### 2. マークダウン生成機能
- **目的**: 変更内容を可読性の高いマークダウンで出力
- **必要な機能**:
  - 新規追加・更新・削除されたページの識別
  - ページプロパティの変更詳細の抽出
  - テンプレート化されたマークダウン生成

### 3. GitHub PR作成・更新機能
- **目的**: 変更内容をPRとして自動作成・更新
- **必要な機能**:
  - GitHub API クライアント
  - 既存PR検索機能
  - 新規PR作成機能
  - 既存PR更新機能（内容追記）
  - ブランチ管理

### 4. スケジューリング機能
- **目的**: 毎日定時実行
- **必要な機能**:
  - cron式またはタイマーベースの定期実行
  - プロセス管理
  - エラーハンドリング・リトライ機能

### 5. 状態管理機能
- **目的**: 実行履歴と状態の管理
- **必要な機能**:
  - 前回実行時のデータベース状態保存
  - 作成済みPR情報の管理
  - 実行ログ・エラーログの記録

## 技術要件

### 環境変数
```
NOTION_API_KEY=<Notion統合トークン>
GITHUB_TOKEN=<GitHub Personal Access Token>
NOTION_DATABASE_ID=<監視対象のデータベースID>
GITHUB_OWNER=<GitHubリポジトリオーナー>
GITHUB_REPO=<GitHubリポジトリ名>
```

### 追加ライブラリ
- `@octokit/rest` - GitHub API クライアント
- `node-cron` - 定期実行用スケジューラー
- データ永続化用（JSONファイルまたはSQLite）

### アーキテクチャ
```
src/
├── notion/
│   ├── client.ts          # Notion APIクライアント
│   ├── database.ts        # データベース操作
│   └── differ.ts          # 差分検出ロジック
├── github/
│   ├── client.ts          # GitHub APIクライアント
│   └── pr-manager.ts      # PR作成・更新
├── markdown/
│   └── generator.ts       # マークダウン生成
├── storage/
│   └── state-manager.ts   # 状態管理
├── scheduler/
│   └── cron.ts           # 定期実行
└── index.ts              # メインエントリポイント
```

## 実装優先度

### Phase 1: コア機能（最優先）
1. **Notion APIクライアント** - APIアクセスの基盤
2. **データベース取得機能** - 基本的なデータ取得
3. **状態管理機能** - 差分検出のための前回状態保存

### Phase 2: 差分検出とマークダウン生成
4. **差分検出ロジック** - 変更の識別
5. **マークダウン生成** - 変更内容の可読化

### Phase 3: GitHub統合
6. **GitHub APIクライアント** - PR操作の基盤
7. **PR作成・更新機能** - 自動PR管理

### Phase 4: 自動化
8. **スケジューリング機能** - 定期実行
9. **エラーハンドリング** - 堅牢性の向上

## TDDアプローチ

### 開発手順
各機能について以下の順序で開発：
1. **テストケース作成** - 期待される動作の定義
2. **最小実装** - テストが通る最小限のコード
3. **リファクタリング** - コード品質の向上
4. **統合テスト** - 機能間の連携確認

### 開始点
Phase 1のNotion APIクライアントからTDDで実装を開始する。

## 主要な技術的課題

- Notion APIのページネーション処理
- GitHub APIの認証とレート制限
- 大量データの差分検出効率化
- 長時間実行プロセスの安定性確保